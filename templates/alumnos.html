{% extends "base.html" %}
{% block title %}Alumnos{% endblock %}

{% block content %}
<div class="container mt-4"> 
  <div class="d-flex justify-content-between align-items-center mb-3"> 
    <h1>Estudiantes</h1>

    <div class="d-flex gap-2 align-items-center">

      <a class="btn btn-outline-success"
         target="_blank"
         href="https://www.google.com/maps/search/?api=1&query={{ 
           'Escuela Primaria 91, Tomas Alva Edison 2164, Isidro Casanova, Buenos Aires, Argentina' 
           | urlencode }}">
        <i class="fas fa-map-marker-alt"></i>
        Escuela
      </a>

      <button class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#modalNuevoAlumno"> 
        + Nuevo Estudiante
      </button>

      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('listar_alumnos',
                          q=q,
                          curso=curso_sel,
                          turno=turno_sel,
                          historico=('0' if ver_historico else '1')) }}">
        {% if ver_historico %}
          Ocultar histórico
        {% else %}
          Ver histórico
        {% endif %}
      </a>

      {% if ver_historico %}
      <form method="post"
            action="{{ url_for('eliminar_demos_alumnos') }}"
            class="form-eliminar-demos mb-0">

        <input type="hidden" name="confirm_demos" value="SI">

        <button type="button"
                class="btn btn-sm btn-outline-danger btn-eliminar-demos"
                title="Eliminar alumnos de prueba">
          <i class="fas fa-broom"></i>
          Eliminar demos
        </button>
      </form>
      {% endif %}

    </div>
  </div>

  <form method="get" class="row g-2 mb-3 align-items-end">
    <div class="col-md-3">
      <input type="text"
             name="q"
             value="{{ q or '' }}"
             class="form-control"
             placeholder="Buscar por nombre, apellido, DNI o curso (Todos si está vacío)">
    </div>
    <div class="col-md-2">
    <label class="form-label">Ciclo Lectivo</label>
    <select name="anio_lectivo" class="form-select" onchange="this.form.submit()">
        <option value="2025" {% if anio_actual == 2025 %}selected{% endif %}>2025</option>
        <option value="2026" {% if anio_actual == 2026 %}selected{% endif %}>2026</option>
        <option value="2027" {% if anio_actual == 2027 %}selected{% endif %}>2027</option>
    </select>
</div>
    <div class="col-md-3">
      <select name="turno" class="form-select">
        <option value="">Todos los turnos</option>
        {% for t in turnos %}
          <option value="{{ t }}" {% if t == turno_sel %}selected{% endif %}>Turno {{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <select name="curso" class="form-select">
        <option value="">Todos los cursos</option>
        {% for c in cursos %}
          <option value="{{ c }}" {% if c == curso_sel %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4 d-flex flex-wrap justify-content-md-end gap-2">
      <button type="submit" class="btn btn-primary">
        Aplicar filtros
      </button>

      <a href="{{ url_for('listar_alumnos') }}"
         class="btn btn-outline-secondary">
        Limpiar
      </a>
    </div>
  </form>

  {% if alumnos %} 
  <div class="table-scroll-wrapper mt-3">

    <div class="table-scroll table-scroll-top">
      <div class="table-scroll-inner"></div>
    </div>

    {% if ver_historico %}
      <div style="margin:8px 0; padding:8px; background:#f3f3f3; border:1px solid #ddd;">
        Mostrando histórico del curso (incluye alumnos dados de baja / pase / egreso).
      </div>
    {% endif %}

    <div class="table-responsive table-main-scroll">
      <table class="table table-sm table-striped align-middle tabla-alumnos">
        <thead class="thead-alumnos">
          <tr>
            <th class="col-curso"      style="width:3%;">Curso</th>
            <th class="col-apellido"   style="width:8%;">Apellido</th>
            <th class="col-nombre"     style="width:8%;">Nombre</th>
            <th class="col-fecha"      style="width:6%;">Fecha nac.</th>
            <th class="col-lugar-nac"  style="width:8%;">Lugar nac.</th>
            <th class="col-edad"       style="width:3%;">Edad<br>(30/6)</th> 
            <th class="col-recursa"    style="width:4%;">Recursa</th>
            <th class="col-sexo"       style="width:3%;">Sexo</th>
            <th class="col-nac-alumno" style="width:4%;">Nac.</th>
            <th class="col-dni"        style="width:6%;">DNI</th>
            <th class="col-cuil"       style="width:8%;">CUIL</th>
            <th class="col-resp"       style="width:10%;">Madre / Padre / Tutor</th>
            <th class="col-ocup"       style="width:6%;">Ocupación</th>
            <th class="col-domicilio"  style="width:10%;">Domicilio</th>
            <th class="col-localidad"  style="width:7%;">Localidad</th>
            <th class="col-escuela-proc" style="width:10%;">Escuela procedencia</th>
            <th class="col-sale-a"      style="width:8%;">Sale a</th>
            <th class="col-tel"        style="width:7%;">Teléfono</th>
            <th class="col-obs"        style="width:8%;">Observaciones</th>
            <th class="col-acciones"   style="width:6%;">Acciones</th>
          </tr>
        </thead> 
        <tbody>
        {% for a in alumnos %}
          <tr class="{% if a.historico_en_curso %}fila-historica{% endif %}">
            <td class="col-curso">{{ a.curso or "" }}</td>
            <td class="col-apellido">{{ a.apellido or "" }}</td>
            <td class="col-nombre">{{ a.nombre or "" }}</td>
            <td class="col-fecha">{{ a.fecha_nac_str or "" }}</td>
            <td class="col-lugar-nac">{{ a.lugar_nacimiento or "" }}</td>
            <td class="col-edad">{{ a.edad_30jun or "" }}</td>
            <td class="col-recursa">{% if a.recursante %}Sí{% else %}No{% endif %}</td>
            <td class="col-sexo">{{ a.sexo or "" }}</td>
            <td class="col-nac-alumno">{{ a.nacionalidad or "" }}</td>
            <td class="col-dni">{{ a.dni or "" }}</td>
            <td class="col-cuil">{{ a.cuil or "" }}</td>
            <td class="col-resp">{{ a.responsable or "" }}</td>
            <td class="col-ocup">{{ a.ocupacion or "" }}</td>
            <td class="col-domicilio">{{ a.domicilio or "" }}</td>
            <td class="col-localidad">{{ a.localidad or "" }}</td>
            <td class="col-escuela-proc">{{ a.escuela_procedencia or "" }}</td>
            <td class="col-sale-a">{{ a.sale_a_str or "" }}</td>
            <td class="col-tel">{{ a.telefono or "" }}</td>
            <td class="col-obs">{{ a.observaciones or "" }}</td>
            <td class="col-acciones text-nowrap">
              <button type="button"
                      class="btn btn-sm btn-outline-primary btn-accion btn-edit-alumno"
                      title="Editar alumno"
                      data-id="{{ a._id }}"
                      data-apellido="{{ a.apellido or '' }}"
                      data-nombre="{{ a.nombre or '' }}"
                      data-curso="{{ a.curso or '' }}"
                      data-dni="{{ a.dni or '' }}"
                      data-cuil="{{ a.cuil or '' }}"
                      data-sexo="{{ a.sexo or '' }}"
                      data-recursante="{{ 'SI' if a.recursante else 'NO' }}"
                      data-fecha-nac="{{ a.fecha_nac_iso or '' }}"
                      data-nacionalidad="{{ a.nacionalidad or '' }}"
                      data-responsable="{{ a.responsable or '' }}"
                      data-ocupacion="{{ a.ocupacion or '' }}"
                      data-domicilio="{{ a.domicilio or '' }}"
                      data-localidad="{{ a.localidad or '' }}"
                      data-telefono="{{ a.telefono or '' }}" 
                      data-lugar-nacimiento="{{ a.lugar_nacimiento or '' }}"
                      data-escuela-procedencia="{{ a.escuela_procedencia or '' }}"
                      data-sale-a="{{ a.sale_a or '' }}"
                      data-motivo-salida="{{ a.motivo_salida or '' }}"
                      data-destino-salida="{{ a.destino_salida or '' }}"
                      data-fecha-salida="{{ a.fecha_salida or '' }}"
                      data-curso-destino="{{ a.curso_destino or '' }}"
                      data-observaciones="{{ a.observaciones or '' }}">
                <i class="fas fa-edit"></i> 
              </button>

              <form method="post"
                    action="{{ url_for('eliminar_alumno', id=a._id) }}"
                    style="display:inline"
                    class="form-eliminar-alumno">
                <input type="hidden" name="q" value="{{ q or '' }}">
                <input type="hidden" name="curso" value="{{ curso_sel or '' }}">
                <input type="hidden" name="turno" value="{{ turno_sel or '' }}">
                <input type="hidden" name="historico" value="{{ '1' if ver_historico else '' }}">
                {% if ver_historico %}
                  <input type="hidden" name="hard" value="1">
                {% endif %}
                <button type="button"
                        class="btn btn-sm {% if ver_historico %}btn-outline-danger{% else %}btn-outline-warning{% endif %} btn-accion btn-eliminar-alumno"
                        data-hard="{{ '1' if ver_historico else '0' }}"
                        title="{% if ver_historico %}Eliminar definitivo{% else %}Pasar a histórico{% endif %}">
                  {% if ver_historico %}
                    <i class="fas fa-trash-alt"></i>
                  {% else %}
                    <i class="fas fa-archive"></i>
                  {% endif %}
                </button>
              </form>

              {% if a.domicilio %}
              <a class="btn btn-sm btn-outline-success btn-accion" title="Ver domicilio en mapa" target="_blank"
                 href="https://www.google.com/maps/dir/?api=1&origin={{ 'Escuela Primaria 91, Tomas Alva Edison 2164, Isidro Casanova, Buenos Aires, Argentina'|urlencode }}&destination={{ (a.domicilio ~ ', Isidro Casanova, Buenos Aires, Argentina')|urlencode }}">
                <i class="fas fa-map-marker-alt"></i>
              </a>
              {% endif %}

              {% if a.curso and a.curso.startswith('6') %}
              <a href="{{ url_for('certificado_finalizacion', id=a._id) }}"
                 class="btn btn-sm btn-outline-secondary btn-accion"
                 title="Certificado de finalización de estudios">
                <i class="fas fa-file-alt"></i>
              </a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="table-scroll table-scroll-bottom">
      <div class="table-scroll-inner"></div>
    </div>
  </div>

  {% else %}
    <div class="alert alert-warning mt-4 text-center">
      No se encontraron alumnos para esta búsqueda.
    </div>
  {% endif %}



     <!-- Modal NUEVO alumno -->
  <div class="modal fade" id="modalNuevoAlumno" tabindex="-1" aria-hidden="true"> 
    <div class="modal-dialog modal-lg ">
      <div class="modal-content">

        <form id="formNuevoAlumno" method="post" action="{{ url_for('nuevo_alumno') }}">
          <div class="modal-header">
            <h5 class="modal-title">Nuevo Estudiante</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label fw-bold text-primary">Ciclo Lectivo</label>
              <select class="form-select border-primary" name="anio_lectivo" required>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
              </select>
              <small class="text-muted">Indica a qué año pertenece esta matrícula</small>
            </div>
          </div>
          <div class="modal-body">
               
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Apellido</label>
                <input type="text" class="form-control" name="apellido" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Nombre</label>
                <input type="text" class="form-control" name="nombre" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Curso</label>
                <input type="text"
                       class="form-control"
                       name="curso"
                       list="lista-cursos"
                       placeholder="Ej: 1°A"
                       required>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">DNI</label>
                <input type="text" class="form-control" name="dni" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">CUIL</label>
                <input type="text" class="form-control" name="cuil">
              </div>
              <div class="col-md-4">
                <label class="form-label">Sexo</label>
                <select class="form-select" name="sexo" required>
                  <option value="">Seleccione…</option>
                  <option>F</option>
                  <option>M</option>
                </select>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">¿Recursa el año?</label>
                <select class="form-select" name="recursante">
                  <option value="NO" selected>No</option>
                  <option value="SI">Sí</option>
                </select>
              </div>
            </div>

            <!-- Fecha, edad y lugar de nacimiento -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Fecha nacimiento</label>
                <input type="date" class="form-control" id="fecha_nac" name="fecha_nac" required>
              </div>
              <div class="col-md-2">
                <label class="form-label">Edad (30/6)</label>
                <input type="number" class="form-control" id="edad_30jun" name="edad_30jun" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Lugar de nacimiento</label>
                <input type="text" class="form-control" id="lugar_nacimiento" name="lugar_nacimiento">
              </div>
            </div>

            <!-- Nacionalidad -->
            <div class="row mb-3">
              <div class="col-md-6 offset-md-4">
                <label class="form-label" for="nacionalidad-select">Nacionalidad</label>

                <select class="form-select" id="nacionalidad-select">
                  <option value="">Seleccione…</option>
                  <option value="Argentina" selected>Argentina</option>
                  <option value="Boliviana">Boliviana</option>
                  <option value="Paraguaya">Paraguaya</option>
                  <option value="Peruana">Peruana</option>
                  <option value="OTRO">Otra (especificar)</option>
                </select>

                <input type="text"
                       class="form-control mt-1"
                       id="nacionalidad-input"
                       name="nacionalidad"
                       value="Argentina"
                       required>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Domicilio</label>
                <input type="text" class="form-control" name="domicilio">
              </div>
              <div class="col-md-6">
                <label class="form-label">Localidad</label>
                <input type="text" class="form-control" name="localidad">
              </div>
            </div>
             <!-- NUEVO: Escuela de procedencia -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Escuela de procedencia</label>
                <input type="text" class="form-control" name="escuela_procedencia">
              </div>
            </div>
  
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Madre / Padre / Tutor</label>
                <input type="text" class="form-control" name="tutor">
              </div>
              <div class="col-md-3">
                <label class="form-label">Ocupación</label>
                <input type="text" class="form-control" name="ocupacion">
              </div>
              <div class="col-md-3">
                <label class="form-label">Teléfono</label>
                <input type="text" class="form-control" name="telefono"> 
              </div>
            </div>

               
            <div class="mb-3">
                <label class="form-label">Observaciones</label> 
                <textarea id="nuevo-observaciones"
                          class="form-control"
                          name="observaciones"
                          rows="2"></textarea>

            </div>


          </div> <!-- /modal-body --> 

          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button class="btn btn-primary" type="submit">
              Guardar
            </button>
          </div>
        </form>

      </div> <!-- /modal-content -->
    </div>   <!-- /modal-dialog -->
  </div>     <!-- /modal -->


  <!-- Modal EDITAR alumno (único, se rellena por JS) -->
  <div class="modal fade" id="modalEditarAlumno" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg ">
      <div class="modal-content">
        <form id="formEditarAlumno" method="post">
          <div class="modal-header">
            <h5 class="modal-title">Editar alumno</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Ciclo Lectivo</label>
              <select class="form-select" id="edit-anio_lectivo" name="anio_lectivo">
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
              </select>
            </div>
          </div>
          </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Apellido</label>
                <input id="edit-apellido" name="apellido" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Nombre</label>
                <input id="edit-nombre" name="nombre" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Curso</label>
                <input id="edit-curso"
                       name="curso"
                       class="form-control"
                       list="lista-cursos"
                       placeholder="Ej: 1°A">
              </div>
            </div>

            <div class="row mb-3"> 
              <div class="col-md-4">
                <label class="form-label">DNI</label>
                <input id="edit-dni" name="dni" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">CUIL</label>
                <input id="edit-cuil" name="cuil" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Sexo</label>
                <select id="edit-sexo" name="sexo" class="form-select">
                  <option value="">Seleccione…</option>
                  <option value="F">F</option>
                  <option value="M">M</option>
                </select>
              </div>
            </div>
             <div class="row mb-3">
               <div class="col-md-4">
                  <label class="form-label">¿Recursa el año?</label>
                  <select id="edit-recursante" name="recursante" class="form-select">
                   <option value="NO">No</option>
                    <option value="SI">Sí</option>
                  </select>
               </div>
              </div>

            <!-- Fecha, edad y lugar de nacimiento (edición) -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Fecha nacimiento</label>
                <input type="date" id="edit-fecha_nac" name="fecha_nac" class="form-control">
              </div>
              <div class="col-md-2">
                <label class="form-label">Edad (30/6)</label>
                <input type="number" id="edit-edad_30jun" name="edad_30jun" class="form-control" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Lugar de nacimiento</label>
                <input type="text" id="edit-lugar_nacimiento" name="lugar_nacimiento" class="form-control">
              </div>
            </div>

            <!-- Nacionalidad (edición) -->
            <div class="row mb-3"> 
              <div class="col-md-6 offset-md-4">
                <label class="form-label" for="edit-nacionalidad-select">Nacionalidad</label>
                <select class="form-select" id="edit-nacionalidad-select">
                  <option value="">Seleccione…</option>
                  <option value="Argentina">Argentina</option>
                  <option value="Boliviana">Boliviana</option>
                  <option value="Paraguaya">Paraguaya</option>
                  <option value="Peruana">Peruana</option>
                  <option value="OTRO">Otra (especificar)</option>
                </select>

                <input type="text"
                       class="form-control mt-1"
                       id="edit-nacionalidad-input"
                       name="nacionalidad">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Domicilio</label>
                <input id="edit-domicilio" name="domicilio" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Localidad</label> 
                <input id="edit-localidad" name="localidad" class="form-control">
              </div>
            </div>
             
            <!-- NUEVO: Escuela de procedencia + Sale a (edición) -->
        
            <div class="row mb-3">
                <div class="col-md-6">
                   <label class="form-label">Escuela de procedencia</label>
                   <input id="edit-escuela_procedencia" name="escuela_procedencia" class="form-control">
                </div>
              
            </div>


            <div class="border p-2 rounded-3 bg-light mb-3">
               <h5 class="small text-muted mb-2">Registro de Movimiento </h5> 

               <div class="row g-2">
                 <div class="col-md-6">
                   <label for="edit-motivo_salida" class="form-label">Motivo de Salida / Sale A</label>
                   <select class="form-select" id="edit-motivo_salida" name="motivo_salida">
                      <option value=""selected>Alumno Activo</option>
                      <option value="CAMBIO DE TURNO">sale por CAMBIO DE TURNO</option>
                      <option value="EGRESO"> sale por EGRESO (Finalización Primaria: 6°)</option>
                      <option value="PASE A OTRA ESCUELA">sale con PASE A OTRA ESCUELA</option>
                   </select>
                 </div>
                <div class="col-md-6">
                  <label for="edit-curso_destino" class="form-label">
                     Curso destino (sólo CAMBIO DE TURNO)
                  </label>
                  <input type="text"
                         class="form-control"
                         id="edit-curso_destino"
                         name="curso_destino"
                         list="lista-cursos"
                         placeholder="Ej: 3°B">
                  </div> 
                 <div class="col-md-6">
                   <label for="edit-destino_salida" class="form-label">Detalle (Destino)</label>
                   <input type="text"
                          class="form-control"
                          id="edit-destino_salida"
                          name="destino_salida"
                          placeholder="N° de Escuela y Distrito o Nuevo Turno">
                   </div>
                 </div>

                 <input type="hidden" id="edit-fecha_salida" name="fecha_salida" value="{{ hoy_str }}">
              </div>


            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Madre / Padre / Tutor</label>
                <input id="edit-responsable" name="tutor" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Ocupación</label>
                <input id="edit-ocupacion" name="ocupacion" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Teléfono</label>
                <input id="edit-telefono" name="telefono" class="form-control">
              </div>
            </div>

         <div class="mb-3">
              <label class="form-label">Observaciones</label>
              <textarea id="edit-observaciones" class="form-control" name="observaciones" rows="2"></textarea>

            </div>
          </div> <!-- /modal-body -->

          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button class="btn btn-primary" type="submit">
              Guardar
            </button>
          </div>
        </form>

      </div> <!-- /modal-content -->
    </div>   <!-- /modal-dialog -->
  </div>     <!-- /modal -->

<!-- Modal confirmación EP91 -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalTitle">Confirmar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="confirmModalBody">
        ¿Confirmás la acción?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmModalOk">Sí, continuar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  
  // showConfirmModal(titulo, mensaje, onOk)
  window.showConfirmModal = function(titulo, mensaje, onOk) {
    const titleEl = document.getElementById("confirmModalTitle");
    const bodyEl  = document.getElementById("confirmModalBody");
    const okBtn   = document.getElementById("confirmModalOk");

    titleEl.textContent = titulo || "Confirmar";
    bodyEl.textContent  = mensaje || "¿Confirmás la acción?";

    // Evitar que queden listeners viejos
    const newOkBtn = okBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOkBtn, okBtn);

    newOkBtn.addEventListener("click", () => {
      try { onOk && onOk(); } finally {
        const modalEl = document.getElementById("confirmModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
      }
    });

    const modalEl = document.getElementById("confirmModal");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }


  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".btn-eliminar-alumno").forEach(btn => {
      btn.addEventListener("click", () => {
        const form = btn.closest("form");
        const hard = btn.dataset.hard === "1";

        const titulo = hard ? "Eliminar definitivo" : "Pasar a histórico";
        const msg = hard
          ? "⚠️ Esto elimina DEFINITIVAMENTE el alumno (no se puede deshacer). ¿Continuar?"
          : "Esto mueve el alumno a HISTÓRICO (baja lógica). ¿Continuar?";

        window.showConfirmModal(titulo, msg, () => form.submit());
      });
    });
  });
  
document.addEventListener("DOMContentLoaded", () => {

  // ✅ Confirmación EP91 para eliminar demos
  document.querySelectorAll(".btn-eliminar-demos").forEach(btn => {
    btn.addEventListener("click", () => {
      const form = btn.closest("form");

      const titulo = "Eliminar demos del histórico";
      const msg = "⚠️ Esto elimina DEFINITIVAMENTE los alumnos de prueba del histórico.\nNo se puede deshacer.\n\n¿Continuar?";

      window.showConfirmModal(titulo, msg, () => form.submit());
    });
  });

});



document.addEventListener("DOMContentLoaded", function () {

  /* ================== SCROLL SINCRONIZADO ================== */
  const mainScroll   = document.querySelector(".table-main-scroll");
  const topScroll    = document.querySelector(".table-scroll-top");
  const bottomScroll = document.querySelector(".table-scroll-bottom");

  if (mainScroll && topScroll && bottomScroll) {
    const table  = mainScroll.querySelector("table");
    const inners = document.querySelectorAll(".table-scroll-inner");

    function actualizarAncho() {
      if (!table) return;
      const ancho = table.scrollWidth;
      inners.forEach(inner => inner.style.width = ancho + "px");
    }

    function syncFrom(source) {
      return () => {
        const x = source.scrollLeft;
        if (source !== mainScroll)   mainScroll.scrollLeft   = x;
        if (source !== topScroll)    topScroll.scrollLeft    = x;
        if (source !== bottomScroll) bottomScroll.scrollLeft = x;
      };
    }

    topScroll.addEventListener("scroll",    syncFrom(topScroll));
    bottomScroll.addEventListener("scroll", syncFrom(bottomScroll));
    mainScroll.addEventListener("scroll",   syncFrom(mainScroll));
    window.addEventListener("resize", actualizarAncho);
    actualizarAncho();
  }

  /* ================== NACIONALIDAD (ALTA + EDICIÓN) ================== */
  function setupNacionalidad(selectId, inputId) {
    const selectNac = document.getElementById(selectId);
    const inputNac  = document.getElementById(inputId);
    if (!selectNac || !inputNac) return;

    function aplicarDesdeSelect() {
      const val = selectNac.value;
      if (val === "OTRO") {
        inputNac.value = "";
        inputNac.readOnly = false;
        inputNac.placeholder = "Escribí la nacionalidad…";
        inputNac.focus();
      } else if (val === "") {
        inputNac.value = "";
        inputNac.readOnly = true;
        inputNac.placeholder = "";
      } else {
        inputNac.value = val;
        inputNac.readOnly = true;
        inputNac.placeholder = "";
      }
    }

    aplicarDesdeSelect();
    selectNac.addEventListener("change", aplicarDesdeSelect);
  }

  setupNacionalidad("nacionalidad-select", "nacionalidad-input");
  setupNacionalidad("edit-nacionalidad-select", "edit-nacionalidad-input");

  /* ================== EDAD AUTOMÁTICA AL 30/6 ================== */
  function calcularEdad30Jun(fechaStr) {
    if (!fechaStr) return "";
    const nac = new Date(fechaStr);
    if (isNaN(nac.getTime())) return "";

    const hoy = new Date();
    const anioRef = hoy.getFullYear();
    const ref = new Date(anioRef, 5, 30);  // 30 junio

    let edad = anioRef - nac.getFullYear();
    const cumpleEseAnio = new Date(anioRef, nac.getMonth(), nac.getDate());
    if (cumpleEseAnio > ref) edad--;

    return edad >= 0 ? edad : "";
  }

  function wireEdad(fechaId, edadId) {
    const fechaInput = document.getElementById(fechaId);
    const edadInput  = document.getElementById(edadId);
    if (!fechaInput || !edadInput) return;

    function actualizarEdad() {
      edadInput.value = calcularEdad30Jun(fechaInput.value);
    }

    actualizarEdad();
    fechaInput.addEventListener("change", actualizarEdad);
  }

  wireEdad("fecha_nac", "edad_30jun");
  wireEdad("edit-fecha_nac", "edit-edad_30jun");

  
 // ================== MOVIMIENTOS (SALE A) ==================
const FECHA_HOY = "{{ hoy_str }}";

function setupMovimiento(motivoId, cursoDestinoId, destinoId, fechaId){
  const selMotivo    = document.getElementById(motivoId);
  const inputCurso   = document.getElementById(cursoDestinoId);
  const inputDestino = document.getElementById(destinoId);
  const inputFecha   = document.getElementById(fechaId);

  // Si alguno no existe, no hacemos nada (evita errores en consola)
  if (!selMotivo || !inputCurso || !inputDestino || !inputFecha) return;

  function actualizar() {
    const v = (selMotivo.value || "").trim().toUpperCase();

    if (!v) {
      // Alumno activo, sin movimiento
      inputCurso.value = "";
      inputCurso.readOnly = true;
      inputCurso.placeholder = "";

      inputDestino.value = "";
      inputDestino.readOnly = true;
      inputDestino.placeholder = "";

      inputFecha.value = "";
      return;
    }

    // Hay movimiento -> guardamos fecha
    if (!inputFecha.value) inputFecha.value = FECHA_HOY;

    if (v === "CAMBIO DE TURNO") {
      // Cambio de turno: curso destino editable
      inputCurso.readOnly = false;
      inputCurso.placeholder = "Ej: 3°B";

      // Destino (detalle) opcional
      inputDestino.readOnly = false;
      inputDestino.placeholder = "Ej: pasa de mañana a tarde";
    } else {
      // Pase/Egreso: curso destino NO se toca
      inputCurso.value = "";
      inputCurso.readOnly = true;
      inputCurso.placeholder = "";

      // Destino sí
      inputDestino.readOnly = false;
      inputDestino.placeholder = "N° de Escuela y Distrito, o detalle";
    }
  }

  actualizar(); 
  selMotivo.addEventListener("change", actualizar);
}

  
  // Editar alumno
  
  setupMovimiento("edit-motivo_salida", "edit-curso_destino", "edit-destino_salida", "edit-fecha_salida");


  /* ================== MODAL EDITAR ALUMNO ================== */

  const modalEditarEl = document.getElementById("modalEditarAlumno");
  const formEditar    = document.getElementById("formEditarAlumno");

  if (modalEditarEl && formEditar) {
    const modalEditar = new bootstrap.Modal(modalEditarEl);

    document.querySelectorAll(".btn-edit-alumno").forEach(btn => {
      btn.addEventListener("click", function () {
        const d = this.dataset;
          // MOVIMIENTOS / SALIDA
        const motivoSel      = document.getElementById("edit-motivo_salida");
        const destinoInput   = document.getElementById("edit-destino_salida");
        const fechaSalidaInp = document.getElementById("edit-fecha_salida");

        if (motivoSel)      motivoSel.value      = d.motivoSalida || "";
        if (destinoInput)   destinoInput.value   = d.destinoSalida || "";
        if (fechaSalidaInp) fechaSalidaInp.value = d.fechaSalida || "";
        
        const cursoDestinoInput = document.getElementById("edit-curso_destino");
        if (cursoDestinoInput) cursoDestinoInput.value = d.cursoDestino || "";

        // Reaplicamos lógica de movimientos por si cambia el select
        setupMovimiento("edit-motivo_salida", "edit-destino_salida", "edit-fecha_salida");

        // Ruta de edición
        formEditar.action = `/alumnos/${d.id}/editar`;

        // Campos básicos
        document.getElementById("edit-apellido").value      = d.apellido || "";
        document.getElementById("edit-nombre").value        = d.nombre || "";
        document.getElementById("edit-curso").value         = d.curso || "";
        document.getElementById("edit-dni").value           = d.dni || "";
        document.getElementById("edit-cuil").value          = d.cuil || "";
        document.getElementById("edit-sexo").value          = d.sexo || "";
        document.getElementById("edit-fecha_nac").value     = d.fechaNac || "";
        document.getElementById("edit-domicilio").value     = d.domicilio || "";
        document.getElementById("edit-localidad").value     = d.localidad || "";
        document.getElementById("edit-responsable").value   = d.responsable || "";
        document.getElementById("edit-ocupacion").value     = d.ocupacion || "";
        document.getElementById("edit-telefono").value      = d.telefono || "";
        document.getElementById("edit-lugar_nacimiento").value = d.lugarNacimiento || "";
        document.getElementById("edit-observaciones").value = d.observaciones || "";
        document.getElementById("edit-anio_lectivo").value  = d.anioLectivo || "2025";


        // Escuela de procedencia
        const escProc = document.getElementById("edit-escuela_procedencia");
        if (escProc) {
          escProc.value = d.escuelaProcedencia || "";
        }

        // Sale a (detalle de destino)
        const saleAInput = document.getElementById("edit-sale_a");
        if (saleAInput) {
          saleAInput.value = d.saleA || "";
        }

        // Recursante
        const recSel = document.getElementById("edit-recursante");
        if (recSel) {
          recSel.value = d.recursante || "NO";
        }

        // Nacionalidad en edición
        const selNac = document.getElementById("edit-nacionalidad-select");
        const inpNac = document.getElementById("edit-nacionalidad-input");
        if (selNac && inpNac) {
          const nacVal = d.nacionalidad || "";
          const opciones = ["Argentina", "Boliviana", "Paraguaya", "Peruana"];
          if (opciones.includes(nacVal)) {
            selNac.value = nacVal;
            inpNac.value = nacVal;
            inpNac.readOnly = true;
          } else if (!nacVal) {
            selNac.value = "";
            inpNac.value = "";
            inpNac.readOnly = true;
          } else {
            selNac.value = "OTRO";
            inpNac.value = nacVal;
            inpNac.readOnly = false;
          }
        }

        // Recalcular edad para el alumno editado
        wireEdad("edit-fecha_nac", "edit-edad_30jun");
       
        modalEditar.show();
      });
    });
  }

});
</script>
</div> {% endblock %}
