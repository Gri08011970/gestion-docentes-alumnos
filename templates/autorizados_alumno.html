{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h2 class="mb-0">Autorizados a retirar</h2>
      <div class="text-muted">
        {{ alumno.apellido }}, {{ alumno.nombre }} ({{ alumno.curso }})
      </div>
    </div>

    <a class="btn btn-secondary"
       href="{{ url_for('autorizados_curso', curso=alumno.curso) }}">
      Volver
    </a>
  </div>

  <form method="post">
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Nombre y apellido</th>
            <th>DNI</th>
            <th>Fecha nac.</th>
            <th class="text-center">Edad</th>
            <th>Parentesco</th>
            <th>Domicilio</th>
            <th>Teléfono</th>
            <th class="text-center">Mapa</th>
          </tr>
        </thead>
        <tbody>

          {% for au in autorizados %}
          <tr>
            <td><input class="form-control" name="aut_nombre[]" value="{{ au.nombre }}"></td>
            <td><input class="form-control" name="aut_dni[]" value="{{ au.dni }}"></td>

            <td>
              <input class="form-control aut-fnac"
                     type="date"
                     name="aut_fnac[]"
                     value="{{ au.fecha_nac }}">
            </td>

            <td class="aut-edad text-center">{{ au.edad or "" }}</td>

            <td><input class="form-control" name="aut_parentesco[]" value="{{ au.parentesco }}"></td>
            <td><input class="form-control aut-dom" name="aut_dom[]" value="{{ au.domicilio }}"></td>
            <td><input class="form-control" name="aut_tel[]" value="{{ au.telefono }}"></td>

            <td class="text-center">
               {% if au.domicilio %}
                 <a class="btn btn-sm btn-outline-success"
                    target="_blank"
                    rel="noopener"
                    title="Ver domicilio en mapa"
                    href="https://www.google.com/maps/dir/?api=1&origin={{ 'Escuela Primaria 91, Tomas Alva Edison 2164, Isidro Casanova, Buenos Aires, Argentina'|urlencode }}&destination={{ (au.domicilio ~ ', Isidro Casanova, Buenos Aires, Argentina')|urlencode }}">
                   <i class="fas fa-map-marker-alt"></i>
                 </a>
               {% else %}
                   <span class="text-muted">—</span>
               {% endif %}
            </td>

          </tr>
          {% endfor %}

          <!-- fila vacía -->
          <tr>
            <td><input class="form-control" name="aut_nombre[]"></td>
            <td><input class="form-control" name="aut_dni[]"></td>
            <td><input class="form-control aut-fnac" type="date" name="aut_fnac[]"></td>
            <td class="aut-edad text-center"></td>
            <td><input class="form-control" name="aut_parentesco[]"></td>
            <td><input class="form-control aut-dom" name="aut_dom[]"></td>
            <td><input class="form-control" name="aut_tel[]"></td>
            <td class="text-center"><span class="text-muted">—</span></td>
          </tr>

        </tbody>
      </table>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary">Guardar autorizados</button>
    </div>
  </form>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  function calcularEdad(fechaStr) {
    if (!fechaStr) return "";
    const nac = new Date(fechaStr);
    if (isNaN(nac.getTime())) return "";

    const hoy = new Date();
    let edad = hoy.getFullYear() - nac.getFullYear();
    const mes = hoy.getMonth() - nac.getMonth();

    if (mes < 0 || (mes === 0 && hoy.getDate() < nac.getDate())) {
      edad--;
    }
    return edad >= 0 ? edad : "";
  }

  function actualizarEdadDesdeInput(input) {
    const fila = input.closest("tr");
    if (!fila) return;
    const celdaEdad = fila.querySelector(".aut-edad");
    if (!celdaEdad) return;
    celdaEdad.textContent = calcularEdad(input.value);
  }

  document.querySelectorAll(".aut-fnac").forEach(function (inp) {
    actualizarEdadDesdeInput(inp);
    inp.addEventListener("change", function () {
      actualizarEdadDesdeInput(inp);
    });
  });

});
</script>
{% endblock %}
