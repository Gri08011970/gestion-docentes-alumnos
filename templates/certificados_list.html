{% extends "base.html" %}
{% block title %}Certificados{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Certificados para entregar</h4>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevo">
      Nuevo certificado
    </button>
  </div>

  <!-- Buscador + filtro -->
<form class="row g-2 mb-3" method="get"> 

  <div class="col-sm-4">
    <label class="form-label mb-0">Buscar por apellido o DNI</label>
    <input type="text"
           class="form-control"
           name="q"
           value="{{ q or '' }}"
           placeholder="Ej. PÉREZ o 30123456">
  </div>

  <div class="col-sm-3">
    <label class="form-label mb-0">Ver</label>
    <select class="form-select"
            name="ver"
            onchange="this.form.submit()">
      <option value="pendientes"
        {% if (ver or 'pendientes') == 'pendientes' %}selected{% endif %}>
        Pendientes
      </option>
      <option value="entregados"
        {% if ver == 'entregados' %}selected{% endif %}>
        Entregados
      </option>
      <option value="todos"
        {% if ver == 'todos' %}selected{% endif %}>
        Todos
      </option>
    </select>
  </div>

  <div class="col-auto align-self-end">
    <button class="btn btn-outline-secondary" type="submit">
      Buscar
    </button>
  </div>

  {% if q or ver %}
  <div class="col-auto align-self-end">
    <a class="btn btn-link"
       href="{{ url_for('certificados_pendientes') }}">
      Quitar filtro
    </a>
  </div>
  {% endif %}
</form>

  {% if certificados %}
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>


          <th>Apellido y nombre</th>
          <th>DNI</th>
          <th>Año promoción</th>
          <th>Observaciones</th>
          <th class="text-center">Entregado</th>
          <th class="text-nowrap">Fecha entrega</th>
          <th class="text-nowrap">Acciones</th>
        </tr>
      </thead>

      <tbody>
        {% for c in certificados %}
        <tr class="{% if c.entregado %}table-success{% endif %}">

          <td>{{ c.apellido }}, {{ c.nombre }}</td>
          <td>{{ c.dni }}</td>
          <td>{{ c.anio_promocion or "" }}</td>
          <td>{{ c.observaciones or "" }}</td>

          <!-- Entregado -->
          <td class="text-center">
            {% if c.entregado %}
              <span class="badge bg-success">Sí</span>
            {% else %}
              <span class="badge bg-secondary">No</span>
            {% endif %}
            <form method="post"
                  action="{{ url_for('marcar_certificado_entregado', id=c._id) }}"
                  class="d-inline ms-2">
              <input type="hidden" name="q" value="{{ q or '' }}">
              <input type="hidden" name="ver" value="{{ ver or 'pendientes' }}">

              <input class="form-check-input"
                     type="checkbox"
                     name="entregado"
                     value="1"
                     onchange="this.form.submit()"
                     {% if c.entregado %}checked{% endif %}>
            </form>
          </td>

          <!-- Fecha entrega -->
          
           <td class="text-nowrap">
             {% if c.fecha_entrega %}
                {{ c.fecha_entrega.strftime("%d/%m/%Y") }}
             {% else %}
                —
             {% endif %}

           </td>


          <!-- Acciones -->
          <td class="text-nowrap">
            <button type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditar"
                    data-id="{{ c._id }}"
                    data-apellido="{{ c.apellido }}"
                    data-nombre="{{ c.nombre }}"
                    data-dni="{{ c.dni }}"
                    data-anio="{{ c.anio_promocion or '' }}"
                    data-obs="{{ c.observaciones or '' }}">
              Editar
            </button>

            <form method="post"
                  action="{{ url_for('eliminar_certificado', id=c._id) }}"
                  class="d-inline"
                  onsubmit="return confirm('¿Eliminar este registro?');">
              <button class="btn btn-sm btn-outline-danger">Eliminar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
  {% else %}
  <div class="alert alert-info">
    No hay certificados cargados para los filtros aplicados.
  </div>
  {% endif %}

</div>

<!-- Modal NUEVO -->
<div class="modal fade" id="modalNuevo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('certificados_pendientes') }}">
      <div class="modal-header">
        <h5 class="modal-title">Nuevo certificado para entregar</h5>
        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Apellido</label>
          <input class="form-control" name="apellido" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input class="form-control" name="nombre" required>
        </div>
        <div class="mb-2">
          <label class="form-label">DNI</label>
          <input class="form-control" name="dni" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Año de promoción</label>
          <input type="number" class="form-control" name="anio_promocion" min="1950" max="2100" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Observaciones (opcional)</label>
          <textarea class="form-control" name="observaciones" rows="2"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal EDITAR -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" id="formEditarCertificado">
      <div class="modal-header">
        <h5 class="modal-title">Editar certificado</h5>
        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Apellido</label>
          <input class="form-control" name="apellido" id="edit_apellido" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input class="form-control" name="nombre" id="edit_nombre" required>
        </div>
        <div class="mb-2">
          <label class="form-label">DNI</label>
          <input class="form-control" name="dni" id="edit_dni" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Año de promoción</label>
          <input type="number" class="form-control" name="anio_promocion" id="edit_anio" min="1950" max="2100" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Observaciones (opcional)</label>
          <textarea class="form-control" name="observaciones" id="edit_obs" rows="2"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary" type="submit">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get("nuevo") === "1") {
         const modal = document.getElementById("modalNuevo");
      if (modal) new bootstrap.Modal(modal).show();
     }
    // Precargar modal Editar
    const modalEditar = document.getElementById("modalEditar");
    if (modalEditar) {
      modalEditar.addEventListener("show.bs.modal", function (event) { 
        const btn = event.relatedTarget;
        if (!btn) return; 

        const id = btn.getAttribute("data-id");
        document.getElementById("edit_apellido").value = btn.getAttribute("data-apellido") || "";
        document.getElementById("edit_nombre").value = btn.getAttribute("data-nombre") || "";
        document.getElementById("edit_dni").value = btn.getAttribute("data-dni") || "";
        document.getElementById("edit_anio").value = btn.getAttribute("data-anio") || "";
        document.getElementById("edit_obs").value = btn.getAttribute("data-obs") || "";

        document.getElementById("formEditarCertificado").action = `/certificados/${id}/editar`;
      });
    }
  });
</script>
{% endblock %}
