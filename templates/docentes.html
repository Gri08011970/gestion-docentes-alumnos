{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">Docentes</h2>

<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalNuevoDocente">
  Agregar docente
</button>

<table class="table table-striped align-middle">
  <thead>
    <tr>
      <th>Nombre y Apellido</th>
      <th style="width: 150px;">Cargo</th>
      <th style="width: 120px;">SituaciÃ³n de Revista</th>
      <th style="width: 200px;">Observaciones</th>
      <th style="width: 120px;" class="text-center">Carga 5Ã—5</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for d in docentes %}
    <tr>
      <td><strong>{{ d.get('apellido','') }}, {{ d.get('nombre','') }}</strong></td>
      
      <td class="small">
        {% if d.get('cargo') %}
          {% for c in d.get('cargo','').split(',') %}
            <div class="badge bg-light text-dark border">{{ c.strip() }}</div>
          {% endfor %}
        {% endif %}
      </td>

      <td class="small">{{ d.get('situacion','') }}</td>
      
      <td>
        <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ d.get('observaciones','') }}">
          {{ d.get('observaciones','') }}
        </div>
      </td>

      <td class="text-center">
        <button class="btn btn-sm btn-outline-primary py-0"
                data-bs-toggle="modal"
                data-bs-target="#modalCargaHoraria"
                data-docente-id="{{ d['_id'] }}"
                data-docente-nombre="{{ d.get('apellido','') }}, {{ d.get('nombre','') }}"
                data-carga='{{ d.get("carga_horaria") | tojson }}'>
          Editar 5Ã—5
        </button>
      </td>

      <td>
        <div class="d-flex gap-1 align-items-center">
          <button type="button"
                  class="btn btn-sm btn-primary btn-edit-docente"
                  data-bs-toggle="modal"
                  data-bs-target="#modalEditarDocente"
                  data-id="{{ d['_id'] }}"
                  data-nombre="{{ d.get('nombre','') }}" 
                  data-apellido="{{ d.get('apellido','') }}"
                  data-cargo="{{ d.get('cargo','') }}"
                  data-situacion="{{ d.get('situacion','') }}"
                  data-fecha="{{ d.get('fecha_ingreso','') }}"
                  data-observaciones="{{ d.get('observaciones','') }}">
            Editar
          </button>

          
          <a class="dropdown-item" href="/docentes/{{ d._id }}/set4?anio=2025" target="_blank">
                  ðŸ“„ Planilla S.E.T. 4
          </a>
          <a class="dropdown-item" href="{{ url_for('docente_inasistencias_anuales', id=d._id) }}" target="_blank">
                  ðŸ“… Calendario Anual
                </a>
          
          <form action="{{ url_for('eliminar_docente', id=d['_id']) }}"
                method="post"
                class="m-0"
                onsubmit="return confirm('Â¿Eliminar docente y sus inasistencias?');">
            <button class="btn btn-sm btn-danger">Eliminar</button>
          </form>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>



<!-- Modal: Nuevo Docente -->
<div class="modal fade" id="modalNuevoDocente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('nuevo_docente') }}" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nuevo docente</h5>
        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>
      <div class="modal-body">

        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input name="nombre" class="form-control" placeholder="Nombre" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Apellido</label>
          <input name="apellido" class="form-control" placeholder="Apellido" required>
        </div>

       <div class="mb-2">
  <label class="form-label">Cargo</label>
  <select name="cargo" id="nuevo-cargo" class="form-select" multiple size="10">
    <option value="PROFESOR">PROFESOR</option>
    <option value="MG">MG (Maestra de grado)</option>
    <option value="MG 5">MG 5 (MAESTRA 5Â° HORA)</option>

    <option value="DIRECTORA">Directora</option>
    <option value="VICE-DIRECTORA">Vice-directora</option>
    <option value="SECRETARIA">Secretaria</option>
    <option value="MAESTRA BIBLIOTECARIA">Maestra bibliotecaria</option>

    <option value="OS">OS</option>
    <option value="OA">OA</option>
    <option value="OE">OE</option>

    <option value="CAMBIO DE FUNCIONES">Cambio de funciones</option>
  </select>

  <small class="text-muted">
    PodÃ©s seleccionar una o varias (Ctrl+clic).
  </small>
</div>
 

        <div class="mb-2">
          <label class="form-label">SituaciÃ³n de Revista</label>
          <select name="situacion" id="nuevo-situacion" class="form-select">
            <option value="Titular">Titular</option>
            <option value="Provisional">Provisional</option>
            <option value="Suplente">Suplente</option>
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Fecha de ingreso (opcional)</label>
          <input type="date" name="fecha_ingreso" class="form-control">
        </div>

        <div class="mb-2">
          <label class="form-label">Observaciones</label>
          <textarea name="observaciones" class="form-control" rows="2"
                    placeholder="Observaciones"></textarea>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Editar Docente -->
<div class="modal fade" id="modalEditarDocente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar docente</h5>
        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>
      <div class="modal-body">

        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input id="edit-nombre" name="nombre" class="form-control" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Apellido</label>
          <input id="edit-apellido" name="apellido" class="form-control" required>
        </div>
        <div class="mb-2">
  <label class="form-label">Cargo</label>

  <!-- IMPORTANTE: name="cargo" -->
  <select id="edit-cargo" name="cargo" class="form-select" multiple size="10">
    <option value="PROFESOR">PROFESOR</option>

    <!-- Como vos querÃ©s que sean distintos -->
    <option value="MG">MG (Maestra de grado)</option>
    <option value="MG 5">MG 5 (Maestra de 5Â° hora)</option>

    <option value="DIRECTORA">Directora</option>
    <option value="VICE-DIRECTORA">Vice-directora</option>
    <option value="SECRETARIA">Secretaria</option>
    <option value="MAESTRA BIBLIOTECARIA">Maestra bibliotecaria</option>

    <option value="OS">OS</option>
    <option value="OA">OA</option>
    <option value="OE">OE</option>

    <option value="CAMBIO DE FUNCIONES">Cambio de funciones</option>
  </select>

  <small class="text-muted">
    PodÃ©s seleccionar una o varias (Ctrl+clic).
  </small>
</div>


        <div class="mb-2">
          <label class="form-label">SituaciÃ³n de Revista</label>
          <select id="edit-situacion" name="situacion" class="form-select">
            <option value="Titular">Titular</option>
            <option value="Provisional">Provisional</option>
            <option value="Suplente">Suplente</option>
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Fecha de ingreso (opcional)</label>
          <input id="edit-fecha_ingreso" type="date" name="fecha_ingreso"
                 class="form-control">
        </div>

        <div class="mb-2">
          <label class="form-label">Observaciones</label>
          <textarea id="edit-observaciones" name="observaciones"
                    class="form-control" rows="2"></textarea>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Carga Horaria 5Ã—5 -->
<div class="modal fade" id="modalCargaHoraria" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Carga Horaria (5Ã—5) â€” <span id="ch-docente-nombre"></span>
        </h5>
        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center carga-5x5">
            <thead>
              <tr>
                <th>Hora / DÃ­a</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>MiÃ©rcoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
              </tr>
            </thead>
            <tbody id="ch-tbody">
              <!-- Se completa por JS (5 filas Ã— 5 columnas de inputs) -->
            </tbody>
          </table>
        </div>
        <small class="text-muted">
          IngresÃ¡ curso / divisiÃ³n / aula o texto libre en cada celda.
        </small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Cerrar</button>
        <button class="btn btn-primary" id="btnGuardarCH">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- Carga horaria 5x5 ---
(() => {
  const modal = document.getElementById('modalCargaHoraria');
  if (!modal) return;

  let DOCENTE_ID = null;
  let MATRIZ = null;

  modal.addEventListener('show.bs.modal', (ev) => {
    const btn = ev.relatedTarget;
    DOCENTE_ID = btn.getAttribute('data-docente-id');
    const nombre = btn.getAttribute('data-docente-nombre');
    const raw = btn.getAttribute('data-carga');

    try { MATRIZ = JSON.parse(raw); } catch { MATRIZ = null; }
    if (!Array.isArray(MATRIZ) || MATRIZ.length !== 5) {
      MATRIZ = Array.from({length:5}, () => Array.from({length:5}, () => "" ));
    }

    document.getElementById('ch-docente-nombre').textContent = nombre;

    const tbody = document.getElementById('ch-tbody');
    tbody.innerHTML = "";

    for (let r = 0; r < 5; r++) {
      const tr = document.createElement('tr');
      const horaLabel = ["1Â°","2Â°","3Â°","4Â°","5Â°"][r];
      tr.innerHTML =
        `<th class="text-nowrap">${horaLabel} hora</th>` +
        Array.from({length:5}, (_, c) => {
          const val = (MATRIZ[r] && typeof MATRIZ[r][c] === 'string') ? MATRIZ[r][c] : "";
          return `<td><input class="form-control form-control-sm text-center ch-cell"
                             data-r="${r}" data-c="${c}"
                             value="${val.replace(/"/g,'&quot;')}"></td>`;
        }).join('');
      tbody.appendChild(tr);
    }
  });

  document.getElementById('btnGuardarCH')?.addEventListener('click', async () => {
    const inputs = modal.querySelectorAll('.ch-cell');
    const nueva = Array.from({length:5}, () => Array.from({length:5}, () => "" ));
    inputs.forEach(inp => {
      const r = parseInt(inp.getAttribute('data-r'), 10);
      const c = parseInt(inp.getAttribute('data-c'), 10);
      nueva[r][c] = inp.value.trim();
    });

    try {
      await axios.post(`/docentes/${DOCENTE_ID}/carga_horaria`, { carga_horaria: nueva });
      bootstrap.Modal.getInstance(modal)?.hide();
      location.reload();
    } catch (e) {
      alert('No se pudo guardar la carga horaria.');
    }
  });
})();


// --- Modal Editar Docente (con cargo multiselect) ---
(() => {
  const modal = document.getElementById('modalEditarDocente');
  if (!modal) return;

  function setMultiSelectValues(selectEl, csvString) {
    const values = (csvString || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    const set = new Set(values);
    for (const opt of selectEl.options) {
      opt.selected = set.has(opt.value);
    }
  }

  modal.addEventListener('show.bs.modal', (ev) => {
    const btn = ev.relatedTarget;
    if (!btn) return;

    const id = btn.getAttribute('data-id');
    const nombre = btn.getAttribute('data-nombre') || "";
    const apellido = btn.getAttribute('data-apellido') || "";
    const cargoCsv = (btn.getAttribute('data-cargo') || "").trim();
    const situacion = btn.getAttribute('data-situacion') || "";
    const fecha = btn.getAttribute('data-fecha') || "";
    const obs = btn.getAttribute('data-observaciones') || "";

    const form = modal.querySelector('form');
    form.action = `/docentes/${id}/editar`;

    modal.querySelector('#edit-nombre').value = nombre; 
    modal.querySelector('#edit-apellido').value = apellido;

    const selCargo = modal.querySelector('#edit-cargo');
    setMultiSelectValues(selCargo, cargoCsv);

    const selSit = modal.querySelector('#edit-situacion');
    if (selSit && situacion) selSit.value = situacion;

    const inpFecha = modal.querySelector('#edit-fecha_ingreso'); 
    if (inpFecha) inpFecha.value = fecha || "";

    const inpObs = modal.querySelector('#edit-observaciones');
    if (inpObs) inpObs.value = obs || "";
  });
})();
</script>

{% endblock %} 
