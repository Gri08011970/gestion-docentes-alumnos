{% extends "base.html" %}
{% block title %}Listas{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h3 class="mb-0">Listas actualizadas</h3>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('listar_alumnos') }}">Volver a Estudiantes</a>
      <button class="btn btn-outline-primary" onclick="window.print()">Imprimir</button>
    </div>
  </div>

  <div class="card mb-3 p-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label mb-1">Curso</label>
        <select class="form-select" id="cursoSelect">
          <option value="">TODOS</option>
          {% for c in cursos_unicos %}
            <option value="{{ c }}" {% if curso_filtrado==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8 d-flex gap-2">
        <button class="btn btn-primary" id="btnAplicar">Aplicar</button>
        <button class="btn btn-outline-secondary" id="btnLimpiar">Limpiar</button>
        <button class="btn btn-outline-dark ms-auto" id="btnImprimirCurso" {% if not curso_filtrado %}disabled{% endif %}>
          Imprimir este curso
        </button>
      </div>
    </div>
  </div>

  {% for curso in cursos_ordenados %}
    <div class="card mb-3 curso-card">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>{{ curso }}</span>
        <button class="btn btn-sm btn-outline-dark btn-print-curso" type="button" data-curso="{{ curso }}">
          Imprimir {{ curso }}
        </button>
      </div>

      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th style="width:50px;">#</th>
              <th>Alumno</th>
            </tr>
          </thead>
          <tbody>
            {% for a in grupos[curso] %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>
                  <div class="fw-semibold">{{ a.apellido or '' }}, {{ a.nombre or '' }}</div>
                  <div class="text-muted small" style="opacity:.75;">DNI: {{ a.dni or '-' }}</div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endfor %}
</div>

<style>
  @media print{
    /* oculto controles */
    #cursoSelect, #btnAplicar, #btnLimpiar, #btnImprimirCurso, .btn-print-curso, .btn, label.form-label{
      display:none !important;
    }
    .curso-card{ page-break-inside: avoid; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const sel = document.getElementById("cursoSelect");
  const btnAplicar = document.getElementById("btnAplicar");
  const btnLimpiar = document.getElementById("btnLimpiar");
  const btnImprimirCurso = document.getElementById("btnImprimirCurso");

  function irConCurso(curso){
    const url = new URL(window.location.href);
    if (curso) url.searchParams.set("curso", curso);
    else url.searchParams.delete("curso");
    window.location.href = url.toString();
  }

  btnAplicar?.addEventListener("click", (e) => { e.preventDefault(); irConCurso(sel.value); });
  btnLimpiar?.addEventListener("click", (e) => { e.preventDefault(); sel.value=""; irConCurso(""); });

  btnImprimirCurso?.addEventListener("click", (e) => {
    e.preventDefault();
    if (!sel.value) return;
    if (new URL(window.location.href).searchParams.get("curso") !== sel.value) {
      const url = new URL(window.location.href);
      url.searchParams.set("curso", sel.value);
      window.location.href = url.toString();
      return;
    }
    window.print();
  });

  document.querySelectorAll(".btn-print-curso").forEach(b => {
    b.addEventListener("click", () => {
      irConCurso(b.dataset.curso);
    });
  });
});
</script>
{% endblock %}
