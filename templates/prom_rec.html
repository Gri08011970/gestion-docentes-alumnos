{% extends "base.html" %}
{% block title %}Promueve / Recursa{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h3 class="mb-0">PROM / REC (Ciclo 2026–2027)</h3>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('listar_alumnos') }}">Volver a Estudiantes</a>
      <button class="btn btn-outline-primary" onclick="window.print()">Imprimir</button>
    </div>
  </div>

  <div class="card mb-3 p-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label mb-1">Curso</label>
        <select class="form-select" id="cursoSelect">
          <option value="">TODOS</option>
          {% for c in cursos_unicos %}
            <option value="{{ c }}" {% if curso_filtrado==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8 d-flex gap-2">
        <button class="btn btn-primary" id="btnAplicar">Aplicar</button>
        <button class="btn btn-outline-secondary" id="btnLimpiar">Limpiar</button>
        <button class="btn btn-outline-dark ms-auto" id="btnImprimirCurso" {% if not curso_filtrado %}disabled{% endif %}>
          Imprimir este curso
        </button>
      </div>
    </div>

    <div class="alert alert-warning py-2 mt-3 mb-0">
      Seleccioná <strong>PROM</strong> o <strong>REC</strong>. Se guarda automáticamente.
    </div>
  </div>

  {% for curso in cursos_ordenados %}
    <div class="card mb-3 curso-card">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>{{ curso }}</span>
        
      </div>

      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th>Alumno</th>
              <th style="width:280px;" class="text-center">Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for a in grupos[curso] %}
              {% set actual = (a.prom_rec_2026_2027 or "") %}
              <tr>
                <td class="ps-3">
                  <div class="fw-semibold">{{ a.apellido or '' }}, {{ a.nombre or '' }}</div>
                  <div class="text-muted small" style="opacity:.75;">DNI: {{ a.dni or '-' }}</div>
                </td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <button type="button"
                            class="btn btn-sm btn-outline-success btn-promrec"
                            data-id="{{ a._id }}"
                            data-valor="PROM">
                      PROM
                    </button>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger btn-promrec"
                            data-id="{{ a._id }}"
                            data-valor="REC">
                      REC
                    </button>
                  </div>
                  <span class="ms-2 badge bg-secondary estado-label" id="lbl-{{ a._id }}">
                    {{ actual if actual else '—' }}
                  </span>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endfor %}
</div>

<style>
  @media print{
    #cursoSelect, #btnAplicar, #btnLimpiar, #btnImprimirCurso, .btn-print-curso, .btn, .alert, label.form-label{
      display:none !important;
    }
    .curso-card{ page-break-inside: avoid; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

  const sel = document.getElementById("cursoSelect");
  const btnAplicar = document.getElementById("btnAplicar");
  const btnLimpiar = document.getElementById("btnLimpiar");
  const btnImprimirCurso = document.getElementById("btnImprimirCurso");

  function irConCurso(curso){
    const url = new URL(window.location.href);
    if (curso) url.searchParams.set("curso", curso);
    else url.searchParams.delete("curso");
    window.location.href = url.toString();
  }

  btnAplicar?.addEventListener("click", (e) => { e.preventDefault(); irConCurso(sel.value); });
  btnLimpiar?.addEventListener("click", (e) => { e.preventDefault(); sel.value=""; irConCurso(""); });

  btnImprimirCurso?.addEventListener("click", (e) => {
    e.preventDefault();
    if (!sel.value) return;
    if (new URL(window.location.href).searchParams.get("curso") !== sel.value) {
      const url = new URL(window.location.href);
      url.searchParams.set("curso", sel.value);
      window.location.href = url.toString();
      return;
    }
    window.print();
  });

  document.querySelectorAll(".btn-print-curso").forEach(b => {
    b.addEventListener("click", () => irConCurso(b.dataset.curso));
  });

  function marcarUI(id, valor) {
    document.querySelectorAll(`.btn-promrec[data-id="${id}"]`).forEach(b => {
      const v = b.dataset.valor;
      const active = (v === valor);

      b.classList.toggle("btn-success", active && v==="PROM");
      b.classList.toggle("btn-danger",  active && v==="REC");
      b.classList.toggle("btn-outline-success", !(active && v==="PROM"));
      b.classList.toggle("btn-outline-danger",  !(active && v==="REC"));
    });

    const lbl = document.getElementById(`lbl-${id}`);
    if (lbl) lbl.textContent = valor || "—";
  }

  async function guardar(id, valor) {
    const r = await fetch("{{ url_for('prom_rec_guardar') }}", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ alumno_id: id, valor })
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.ok) throw new Error(data.error || ("HTTP " + r.status));
  }

  // Inicializar UI
  document.querySelectorAll(".estado-label").forEach(lbl => {
    const id = lbl.id.replace("lbl-", "");
    const v = (lbl.textContent || "").trim().toUpperCase();
    if (v === "PROM" || v === "REC") marcarUI(id, v);
  });

  document.querySelectorAll(".btn-promrec").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const valor = btn.dataset.valor;

      marcarUI(id, valor); // optimista
      try {
        await guardar(id, valor);
      } catch (e) {
        alert("No se pudo guardar PROM/REC. Revisá conexión/DB.");
        console.error(e);
      }
    });
  });
});
</script>
{% endblock %}
